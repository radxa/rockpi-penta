#!/bin/sh
# postinst script for rockpi-penta.
#
# See: dh_installdeb(1).

set -e

PACKAGE_DIR="/usr/share/rockpi-penta"

is_armbian() {
    [ -f /boot/armbianEnv.txt ] || [ -f /boot/dietpiEnv.txt ]
}

armbian_require_overlay() {
    envFile='/boot/armbianEnv.txt'
    [ -f /boot/dietpiEnv.txt ] && envFile='/boot/dietpiEnv.txt'
    overlays=$(grep '^overlays=' "$envFile" | cut -d'=' -f2)
    for arg in "$@"; do
        if echo $overlays | grep -qE "(^|[[:space:]])$arg([[:space:]]|$)"; then
            echo "Overlay ${arg} was already added to $envFile, skip..."
        else
            overlays="${overlays} ${arg}"
            echo "Added overlay: $arg"
        fi
    done
    if grep -q "^overlays=" $envFile; then
        sed '/^overlays=/c\'"overlays=$overlays" -i $envFile
    else
        echo "overlays=$overlays" >> $envFile
    fi
}

dtbo_enable() {
    for arg in "$@"; do
        mv /boot/dtbo/${arg}.dtbo{.disabled,} || true
    done
}

# Install Python packages from requirements.txt
requirements_path="$PACKAGE_DIR/requirements.txt"
if [ -f $requirements_path ]; then
    if [ "$(python3 -c 'import sys; print(f"{sys.version_info.minor >= 11}")')" = "True" ]; then
        pip3 install --root-user-action ignore --no-cache-dir -r $requirements_path --break-system-packages
    else
        pip3 install --root-user-action ignore --no-cache-dir -r $requirements_path
    fi
fi

model=$(tr -d '\0' </proc/device-tree/model || true)

case "$model" in
    *"Raspberry Pi 5"*)
        raspi-config nonint do_i2c 0 >/dev/null || true
        ln -sf $PACKAGE_DIR/env/rpi5.env /etc/rockpi-penta/environment
        ;;

    *"Raspberry Pi 4"*)
        raspi-config nonint do_i2c 0 >/dev/null || true
        ln -sf $PACKAGE_DIR/env/rpi4.env /etc/rockpi-penta/environment
        ;;

    *"ROCK 5"*)
        if is_armbian; then
            armbian_require_overlay rk3588-i2c8-m2 rk3588-pwm14-m1
            ln -sf $PACKAGE_DIR/env/rock_5a_armbian.env /etc/rockpi-penta/environment
        else
            dtbo_enable rk3588-i2c8-m2 rk3588-pwm14-m1
            ln -sf $PACKAGE_DIR/env/rock_5a.env /etc/rockpi-penta/environment
            u-boot-update || true
        fi
        ;;

    *"ROCK3 Model C"*)
        dtbo_enable rk3568-i2c3-m0
        ln -sf $PACKAGE_DIR/env/rock_3c.env /etc/rockpi-penta/environment
        u-boot-update || true
        ;;

    *"ROCK3 Model A"*)
        dtbo_enable rk3568-i2c3-m0 rk3568-pwm15-m0
        ln -sf $PACKAGE_DIR/env/rock_pi_3.env /etc/rockpi-penta/environment
        u-boot-update || true
        ;;

    *"Radxa ROCK 4SE"* | *"ROCK Pi 4"*)
        if is_armbian; then
            dtc -o /boot/dtb/rockchip/overlay/rockchip-rk3399-pwm1-by-rockpi-penta.dtbo \
                -I dts -O dtb -@ $PACKAGE_DIR/overlays/rk3399-pwm1.dts
            armbian_require_overlay rk3399-i2c7 rk3399-pwm1-by-rockpi-penta
            ln -sf $PACKAGE_DIR/env/rock_pi_4_armbian.env /etc/rockpi-penta/environment
        else
            dtbo_enable rk3399-i2c7 rk3399-pwm1
            ln -sf $PACKAGE_DIR/env/rock_pi_4.env /etc/rockpi-penta/environment
            u-boot-update || true
        fi
        ;;

    *)
        echo "WARNING! Board ($model) not supported."
        ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
