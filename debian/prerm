#!/bin/sh
# prerm script for rockpi-penta.
#
# See: dh_installdeb(1).

set -e

PACKAGE_DIR="/usr/share/rockpi-penta"

is_armbian() {
    [ -f /boot/armbianEnv.txt ] || [ -f /boot/dietpiEnv.txt ]
}

dtbo_disable() {
    for arg in "$@"; do
        mv /boot/dtbo/${arg}.dtbo{,.disabled} || true
    done
}

armbian_remove_overlay() {
    envFile='/boot/armbianEnv.txt'
    [ -f /boot/dietpiEnv.txt ] && envFile='/boot/dietpiEnv.txt'
    for arg in "$@"; do
        if sed -E "/overlays=/{s/(=|[[:space:]])$arg([[:space:]]|$)/\1/g;t;:a;n;\$!ba;q1}" -i $envFile; then
            echo "Removed overlay: $arg"
        else
            echo "Overlay ${arg} was not added to $envFile, skip..."
        fi
    done
}

# Install Python packages from requirements.txt
requirements_path="$PACKAGE_DIR/requirements.txt"
if [ -f $requirements_path ]; then
    if [ "$(python3 -c 'import sys; print(f"{sys.version_info.minor >= 11}")')" = "True" ]; then
        pip3 uninstall --root-user-action ignore -y -r $requirements_path --break-system-packages
    else
        pip3 uninstall --root-user-action ignore -y -r $requirements_path
    fi
fi

rm -f /etc/rockpi-penta/environment
find /usr/share/rockpi-penta -type d -name '__pycache__' -exec rm -rf {} +

model=$(tr -d '\0' </proc/device-tree/model || true)

case "$model" in
    *"Raspberry Pi 5"*)
        raspi-config nonint do_i2c 1 >/dev/null || true
        ;;
    *"Raspberry Pi 4"*)
        raspi-config nonint do_i2c 1 >/dev/null || true
        ;;
    *"ROCK 5"*)
        if is_armbian; then
            armbian_remove_overlay rk3588-i2c8-m2 rk3588-pwm14-m1
        else
            dtbo_disable rk3588-i2c8-m2 rk3588-pwm14-m1
            u-boot-update || true
        fi
        ;;
    *"ROCK3 Model C"*)
        dtbo_disable rk3568-i2c3-m0
        u-boot-update || true
    ;;
    *"ROCK3 Model A"*)
        dtbo_disable rk3568-i2c3-m0 rk3568-pwm15-m0
        u-boot-update || true
    ;;
    *"Radxa ROCK 4SE"* | *"ROCK Pi 4"*)
        if is_armbian; then
            rm -f /boot/dtb/rockchip/overlay/rockchip-rk3399-pwm1-by-rockpi-penta.dtbo
            armbian_remove_overlay rk3399-i2c7 rk3399-pwm1-by-rockpi-penta
        else
            dtbo_disable rk3399-i2c7 rk3399-pwm1
            u-boot-update || true
        fi
        ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
